# Постепенный возврат инвайт-кодов

## 🎯 Проблема

В Sora коды появляются **постепенно**:
- ✅ **1-й код** — сразу после регистрации
- ⏳ **2-й код** — когда кто-то активирует 1-й код (6-24 часа)
- ⏳ **3-й код** — когда кто-то активирует 2-й код (24-48 часов)
- ⏳ **4-й код** — когда кто-то активирует 3-й код (48-72 часа)

Пользователь **НЕ видит все коды сразу** — только по одному за раз!

## ✅ Решение

### 1. Увеличенный дедлайн: 72 часа
Вместо 48 часов даём 72 часа на возврат всех кодов.

### 2. Постепенная отправка
Пользователь может отправлять коды **по мере появления**:
- **Сразу**: 1-й код (появляется после регистрации)
- **Через 6-24ч**: 2-й код (когда активируют 1-й)
- **Через 24-48ч**: 3-й код (для первых 10 пользователей)

### 3. Напоминания скорректированы
- **6 часов** — напоминание отправить 1-й код
- **24 часа** — напоминание проверить 2-й код
- **48 часов** — финальное напоминание

### 4. Защита от мошенничества
Бот проверяет, что пользователь не возвращает **свой собственный код**, который он получил от бота.

## 📋 Новая логика в сообщениях

### При получении инвайта

```
⚠️ ВАЖНО про коды:
• После регистрации 1-й код появится сразу ✨
• В Sora виден только 1 код за раз
• Следующий код появится когда кто-то активирует предыдущий
• Обычно это занимает 6-24 часа

Возвращай коды постепенно:
• 1-й код — отправь СРАЗУ (появится после регистрации)
• 2-й код — отправь когда появится (через 6-24ч)
• 3-й код — отправь когда появится (через 24-48ч)

⏰ Общий дедлайн: 72 часа
```

### При отправке кодов

```
📨 Отправка кодов

Нужно вернуть: 3 кодов
Уже возвращено: 1
Осталось: 2

⚠️ Помни: 
• 1-й код появляется СРАЗУ после регистрации — отправь его!
• Следующие коды появляются по 1 за раз
• Обычно это занимает 6-24 часа

Можешь отправить 1 код сейчас, а остальные позже когда появятся.
```

## 🛡️ Защита от мошенничества

### Проверка собственного кода

```javascript
// Получаем коды от пользователя
const codes = extractCodes(text);

// Проверяем что пользователь не отправляет свой код
const ownCode = user.invite_code_given?.toUpperCase();
const filteredCodes = codes.filter(code => code !== ownCode);

if (filteredCodes.length < codes.length) {
  await ctx.reply(
    `⚠️ Нельзя возвращать свой собственный инвайт-код!\n\n` +
    `Твой код: ${ownCode}\n` +
    `Возвращай коды, которые ТЕБЕ выдала Sora.`
  );
}
```

### Что проверяется:
- ✅ Код не совпадает с кодом, который получил пользователь
- ✅ Пользователь может отправлять коды частями
- ✅ Отслеживается прогресс возврата (сколько уже вернул)

## 📊 Примеры сценариев

### Сценарий 1: Идеальный пользователь

**День 1, через 10 минут после получения инвайта:**
- Зарегистрировался в Sora
- Увидел 1-й код
- Отправил 1-й код в бот ✅
- Статус: 1 из 2 кодов возвращено

**День 1, через 12 часов:**
- В Sora появился 2-й код (кто-то активировал 1-й)
- Отправил 2-й код в бот ✅
- Статус: 2 из 2 кодов возвращено
- **COMPLETED** ✅

### Сценарий 2: Медленный пользователь

**День 1:**
- Получил инвайт, зарегистрировался
- Статус: 0 из 2

**День 1, +6 часов:**
- Получил напоминание: "Отправь 1-й код"
- Отправил 1-й код ✅
- Статус: 1 из 2

**День 2:**
- Получил напоминание: "Проверь 2-й код"
- В Sora появился 2-й код
- Отправил 2-й код ✅
- **COMPLETED** ✅

### Сценарий 3: Мошенник (попытка обмана)

**Пользователь получил код:** `ABC123`

**Попытка вернуть свой код:**
```
ABC123
DEF456
```

**Ответ бота:**
```
⚠️ Нельзя возвращать свой собственный инвайт-код!

Твой код: ABC123
Возвращай коды, которые ТЕБЕ выдала Sora после регистрации.

✅ Принят код: DEF456
Осталось: 1 код
```

## 🎯 Преимущества новой логики

1. **Реалистично** — учитывает как работает Sora
2. **Гибко** — пользователь может отправлять коды по мере появления
3. **Справедливо** — больше времени (72ч вместо 48ч)
4. **Безопасно** — защита от возврата своего кода
5. **Понятно** — четкие инструкции на каждом этапе

## ⚙️ Технические детали

### Изменения в config.js
```javascript
rules: {
  deadlineHours: 72,            // Было: 48
  reminderIntervals: [6, 24, 48] // Было: [24, 40, 47]
}
```

### Отслеживание прогресса
```javascript
user: {
  invite_code_given: "ABC123",  // Код, который получил от бота
  codes_returned: 1,             // Сколько уже вернул
  codes_submitted: ["DEF456"]    // Какие коды вернул
}
```

---

**Готово к тестированию!** 🚀

После деплоя проверь:
1. ✅ Пользователь может отправить 1 код сразу
2. ✅ Может отправить остальные позже
3. ✅ Не может вернуть свой собственный код
4. ✅ Видит прогресс (1 из 2, 2 из 3 и т.д.)

